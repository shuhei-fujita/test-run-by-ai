---
name: "Plan Test"
description: テスト実行計画の生成・進捗確認
category: Testing
tags: [testing, planning, progress]
---

テスト実行計画の生成・進捗確認を行うコマンド。

**Input**: `$ARGUMENTS` — `test-suites/` 配下のフォルダ名（案件名）を指定

## 実行手順

### Step 1: 案件フォルダの確認

- `test-suites/$ARGUMENTS/test_suite.md` の存在を確認する
- 存在しない場合:
  - エラーメッセージを表示
  - `test-suites/` 配下のフォルダ一覧を提示して案件名の選択を促す
  - 処理を終了する

### Step 2: モード判定

- `test-suites/$ARGUMENTS/task.md` を確認する
- **生成モード**: `task.md` が存在しない、または空の場合
- **進捗確認モード**: `task.md` にチェックリスト（`- [ ]`, `- [x]`, `- [FAIL]`, `- [SKIP]`, `- [BLOCKED]`）が存在する場合

### Step 3A: 生成モード

#### 3A-1. バリデーション（不足情報の検出）

計画生成の前に以下をチェックし、問題があれば `⚠ 警告` として一覧表示する。

**テストIDタグチェック:**
- test_suite.md 内の全 `Scenario:` 行を抽出する
- 各 Scenario の直前行に `@TC-X-Y` 形式のタグが存在するか確認する
- タグ未設定のシナリオがあれば警告を表示する:
  ```
  ⚠ タグ未設定のシナリオがあります:
    - Scenario: {シナリオ名}（行{N}）
    - Scenario: {シナリオ名}（行{N}）
  → @TC-X-Y タグを付与してから実行してください
  ```

**環境変数チェック:**
- 案件フォルダの `.env` またはルートの `.env` に以下が定義されているか確認する:
  - `TEST_USER_EMAIL` — 未設定なら警告
  - `TEST_USER_PASSWORD` — 未設定なら警告
  - `BASE_URL` — 未設定なら警告
- test_suite.md 内のURL（冒頭のURL行）と `.env` の `BASE_URL` を比較し、ホストが異なる場合は警告する

**テストデータチェック:**
- test_suite.md の Scenario 内に以下のキーワードがあるか検索する:
  - 「CSVを用意」「CSVをアップロード」「ファイルをアップロード」等 → 案件フォルダ内に対応する CSV/データファイルが存在するか確認。なければ警告
  - 「テストデータ」「事前に作成」等 → テストデータの準備手順が不明な場合は警告

**前提条件チェックリスト生成:**
- 全 Scenario の `Given` 句を抽出する
- 環境・データに依存する前提条件（例:「〜が存在する」「〜が設定されている」）を抽出し、task.md の「判断が必要な項目」セクションに **事前準備チェックリスト** として出力する:
  ```
  ## 判断が必要な項目

  ### 事前準備チェックリスト
  - [ ] {前提条件1} — 対象シナリオ: {シナリオ名}
  - [ ] {前提条件2} — 対象シナリオ: {シナリオ名}
  ```

**警告があった場合:**
- 全警告を一覧表示する
- AskUserQuestion で「警告を確認の上、計画生成を続行しますか？」と確認する
- ユーザーが続行を選んだ場合のみ次のステップに進む

#### 3A-2. 計画生成

1. `test-suites/$ARGUMENTS/test_suite.md` を読み込む
2. 環境変数を読み込む（案件フォルダの `.env` → ルートの `.env` の優先順位）
3. test_suite.md から Scenario を抽出し、カテゴリ（`# ■` コメントブロック）でグルーピングする
4. 実行順序を画面遷移の効率で最適化する（同じ画面のシナリオをまとめる）
5. 各シナリオに「手法」を推定して付与する:
   - 表示確認系 → スナップショット確認
   - ダウンロード系 → DLファイル確認
   - API通信系 → API傍受
   - その他 → スクリーンショット
6. `.claude/rules/test-workflow.md` の task.md フォーマット仕様に従って `test-suites/$ARGUMENTS/task.md` に書き出す。結果保存先のタイムスタンプは **JST（日本標準時）** で生成する
7. 進捗サマリの初期値を設定する（全件「未実行」）
8. AskUserQuestion で「この計画で実行開始しますか？」と確認する

### Step 3B: 進捗確認モード

1. `test-suites/$ARGUMENTS/task.md` を読み込む
2. チェックリストのステータスを集計し、進捗サマリを再計算して表示する:
   - `- [ ]` → 未実行
   - `- [x]` → PASS
   - `- [FAIL]` → FAIL
   - `- [SKIP]` → SKIP
   - `- [BLOCKED]` → BLOCKED
3. task.md 内の進捗サマリテーブルを最新値で更新する
4. FAIL / BLOCKED のシナリオがあれば一覧表示し、対応方針を相談する（HITL）
5. 次に実行すべき未実行シナリオを提示する
6. AskUserQuestion で「次のアクション」を確認する:
   - テスト実行を続行 → `/playwright-cli @test-suites/$ARGUMENTS/test_suite.md` への案内
   - 特定シナリオを再実行
   - 計画を修正

## ガードレール

- **test_suite.md は読み取り専用**。絶対に変更しない
- **task.md のみ**が書き込み対象
- 進捗サマリは毎回再計算する（手動編集への追従）
- `.claude/rules/test-workflow.md` の HITL ルールに従う
