# テスト運用ワークフロールール

## フォルダ構成規約

### 案件名の命名規則

- パス区切りと紛らわしい文字は使用禁止: `／`（全角スラッシュ）、`/`（半角スラッシュ）、`\`
- 区切りにはアンダースコア `_` を使う
- 半角英数字・日本語・アンダースコア・ハイフンのみ使用可

```
test-suites/{案件名}/
  ├── test_suite.md   # テスト設計（Gherkin形式）
  ├── task.md          # テスト実行計画・進捗管理（/plan-test が生成）
  ├── .env             # 案件固有の環境変数（任意）
  └── *.csv            # テストデータ（任意）
```

## task.md フォーマット仕様

```markdown
# テスト実行計画: {案件名}

## 環境情報
- URL: {テストスイート内のURL}
- 結果保存先: test-results/{YYYYMMDDHHmm_JST}_{案件名}/
- 再実行結果: test-results/{YYYYMMDDHHmm_JST}_{案件名}_retry/  ← リトライ時のみ追記

## 進捗サマリ
| 合計 | PASS | FAIL | BLOCKED | 未実行 |
| ---- | ---- | ---- | ------- | ------ |
| N    | 0    | 0    | 0       | N      |

## 実行計画

### ■ 1. {カテゴリ名}（{シナリオ数}件）
対象画面: ...

- [ ] **TC-X-Y: シナリオ名**
  - 手法: {スナップショット確認 / API傍受 / スクリーンショット / DLファイル確認}
  - 結果:
  - 備考:

### ■ 2. ...

## 判断が必要な項目
（HITL対象を集約）

## テスト実施メモ
（実行中に判明した注意点を追記）
```

## ステータス定義（4段階）

| 記法          | 意味    | 説明                                                         |
| ------------- | ------- | ------------------------------------------------------------ |
| `- [ ]`       | 未実行  | まだテストしていない                                         |
| `- [x]`       | PASS    | 期待結果と一致                                               |
| `- [FAIL]`    | FAIL    | 期待結果と不一致（バグ or 仕様変更）                         |
| `- [BLOCKED]` | BLOCKED | 実行不可（前提条件不足・環境障害・他シナリオ待ち等）。理由は備考に記載 |

## HITL ルール（人の判断が必要なタイミング）

以下の状況では**テスト実行を一時停止**し、ユーザーに確認する:

1. **FAIL発生時**: 再実行すべきか、バグ報告に切り替えるか
2. **テストデータ不足**: 必要なデータが存在しない・作成できない場合。AI はデータ作成に必要な API リクエスト例をテスト実施メモに提案として記録し、人間に実行を委ねる。将来的には OpenAPI/Swagger 定義を参照して提案精度を向上させる
3. **環境問題**: ログイン不可、ページロードエラー、API 5xx 等
4. **仕様不明**: テストシナリオの期待結果が曖昧で判断できない
5. **破壊的操作の確認**: データ削除、設定変更など元に戻しにくい操作の前
6. **テストスイートとの乖離**: 画面の実装がテスト設計と明らかに異なる場合
7. **BLOCKED 3件以上**: ブロッカーが蓄積している場合は方針転換を相談

## ファイル出力先の原則

- **スクリーンショット**: `test-results/{timestamp}_{案件名}/` に保存。ファイル名は `TC-X-Y_{scenario名}.png`（IDがないシナリオは `{scenario名}.png`）。連番プレフィックス（`01_` 等）は使用禁止。ルート直下やtest-suites内に出力しない
- **再実行（リトライ）結果**: 初回フォルダのSSは上書きせず、新しいtimestampフォルダ `test-results/{timestamp}_{案件名}_retry/` に保存する。task.md の環境情報に `再実行結果:` 行を追記する。初回FAILの証跡を残すことで「何を再実行したか」が明確になる
- **トレース**: 全シナリオで常時記録する。シナリオ単位の場合は `test-results/{timestamp}_{案件名}/traces/TC-X-Y_{scenario名}.trace.zip`、セッション単位の場合は `test-results/{timestamp}_{案件名}/trace.zip` に保存する。閲覧は `npx playwright show-trace {path}` で行う。詳細は `playwright-cli-test-tips.md` を参照
- **中間ファイル（YAML/ログ）**: `.playwright-cli/` 内のみ。プロジェクトルートや `test-suites/` に YAML を配置しない
- **`page.screenshot()` の path 指定**: 必ず `test-results/` または `.playwright-cli/` のフルパスを指定する。`'screenshot.png'` のような相対パスは禁止
- YAML（`.yml`/`.yaml`）ファイルがルートや `test-suites/` に生成された場合は業務データとの混在リスクがあるため、発見次第削除する

## テスト操作の原則

- **ユーザー操作のみでテストする**: ブラウザ上のUI操作（クリック、入力、スクロール等）だけで検証する
- **直接HTTPリクエストによる副作用禁止**: `page.request.post/put/patch/delete`等でAPIを直接叩いてデータを変更しない。GETによる情報取得（`page.request.get`等）は許可
- **API傍受はroute/リクエストイベントで行う**: リクエスト/レスポンスの内容確認が必要な場合は、`page.on('request')`や`page.route()`でユーザー操作に伴う通信を傍受する
- テストはあくまでエンドユーザーと同じ操作フローで実施し、裏側のAPI呼び出しは「観察」に留める

## task.md 更新の義務

以下のタイミングで **必ず** task.md を更新する:

1. **テストシナリオ完了時**: ステータス・結果・備考を即座に反映
2. **一時停止時（HITL・ユーザー中断）**: 進捗サマリとテスト実施メモを最新化してから停止
3. **テスト終了時**: 全シナリオのステータスと進捗サマリを確定

更新内容:
- 各シナリオのチェックボックス（`- [ ]` → `- [x]` / `- [FAIL]` 等）。表記は必ず `TC-X-Y: シナリオ名` のセット形式
- 進捗サマリの数値（PASS / FAIL / BLOCKED / 未実行）
- テスト実施メモ（判明した注意点・画面固有情報）

## テスト実行ライフサイクル

```
計画 ──→ 実行 ──→ 結果確認 ──→ 完了
 │         │         │
 │         ├→ HITL（上記7条件）
 │         └→ task.md 更新（必須）
 │
 └→ /plan-test で task.md 生成
```
